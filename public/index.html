<!doctype html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Chess App</title>

      <link rel="stylesheet" href="/css/chessground.base.css" />
      <link rel="stylesheet" href="/css/chessground.brown.css" />
      <link rel="stylesheet" href="/css/chessground.cburnett.css" />

      <style>
         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
         }

         body {

            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
         }

         .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            text-align: center;
         }
         #chessboard {
            width: 512px;
            height: 512px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            filter: saturate(1.2); /* Slightly increased saturation for visual appeal */
            margin-bottom: 30px;
      </style>
   </head>
   <body>
      <div class="container">
         <div id="chessboard"></div>
         <div class="controls">
            <p id="status">Loading status...</p>
            <div
               id="game-info"
               style="
                  margin-top: 20px;
                  padding: 15px;
                  background: #f8f9fa;
                  border-radius: 8px;
                  font-size: 14px;
               "
            >
               <p>
                  <strong>Current Turn:</strong>
                  <span id="current-turn">White</span>
               </p>
               <p>
                  <strong>Moves Made:</strong> <span id="move-count">0</span>
               </p>
               <p>
                  <strong>Status:</strong>
                  <span id="game-status">Game Started</span>
               </p>
               <button
                  id="reset-button"
                  style="
                     margin-top: 10px;
                     padding: 8px 16px;
                     background: #007bff;
                     color: white;
                     border: none;
                     border-radius: 4px;
                     cursor: pointer;
                  "
               >
                  Reset Board
               </button>
            </div>
         </div>

         <!-- Load chess.js library from CDN for global access -->
         <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0-beta.8/chess.js"></script>

         <!-- Then import our setup script -->
         <script type="module">
            import { initializeChessboard } from "/js/chessground-setup.js";

            let chessboardInstance = null;

            /**
             * Initialize the chess board with all features enabled
             */
            function setupChessboard() {
               const chessboardElement = document.getElementById("chessboard");
               if (!chessboardElement) {
                  console.error(
                     "‚ùå The 'chessboard' element was not found in the DOM. Chessground cannot be initialized.",
                  );
                  return;
               }

               try {
                  // Ensure Chess is available globally before initializing
                  if (typeof Chess === "undefined") {
                     console.error(
                        "‚ùå chess.js library is not loaded or available globally.",
                     );
                     return;
                  }
                  chessboardInstance = initializeChessboard(chessboardElement);
                  console.log("‚úÖ Chessboard setup completed successfully!");
                  updateGameInfo();
               } catch (error) {
                  console.error("‚ùå Failed to initialize chessboard:", error);
               }
            }

            /**
             * Update game information display
             */
            function updateGameInfo() {
               if (!chessboardInstance) return;

               const gameStatus = chessboardInstance.getGameStatus();
               const currentTurnElement =
                  document.getElementById("current-turn");
               const moveCountElement = document.getElementById("move-count");
               const gameStatusElement = document.getElementById("game-status");

               if (currentTurnElement) {
                  currentTurnElement.textContent =
                     gameStatus.currentTurn.charAt(0).toUpperCase() +
                     gameStatus.currentTurn.slice(1);
               }

               if (moveCountElement) {
                  moveCountElement.textContent = Math.floor(
                     gameStatus.history.length / 2,
                  );
               }

               if (gameStatusElement) {
                  if (gameStatus.isCheckmate) {
                     gameStatusElement.textContent = "üèÅ Checkmate!";
                     gameStatusElement.style.color = "#dc3545";
                  } else if (gameStatus.isStalemate) {
                     gameStatusElement.textContent = "ü§ù Stalemate - Draw!";
                     gameStatusElement.style.color = "#ffc107";
                  } else if (gameStatus.isCheck) {
                     gameStatusElement.textContent = "‚ö†Ô∏è  Check!";
                     gameStatusElement.style.color = "#dc3545";
                  } else {
                     gameStatusElement.textContent = "Game in Progress";
                     gameStatusElement.style.color = "#28a745";
                  }
               }
            }

            /**
             * Setup reset button functionality
             */
            function setupResetButton() {
               const resetButton = document.getElementById("reset-button");
               if (resetButton) {
                  resetButton.addEventListener("click", () => {
                     if (chessboardInstance) {
                        chessboardInstance.resetBoard();
                        updateGameInfo();
                        console.log("‚ôªÔ∏è  Board has been reset");
                     }
                  });
               }
            }

            /**
             * Monitor moves and update game info
             */
            function setupMoveMonitoring() {
               if (!chessboardInstance) return;

               // Ensure ground and its state are available
               if (
                  !chessboardInstance.ground ||
                  !chessboardInstance.ground.state ||
                  !chessboardInstance.ground.state.movable ||
                  !chessboardInstance.ground.state.movable.events
               ) {
                  console.warn(
                     "Chessground instance or its event handlers not fully available for move monitoring.",
                  );
                  return;
               }

               // Store the original after function if it exists
               const originalAfterMove =
                  chessboardInstance.ground.state.movable.events.after;

               // Wrap it to also update game info
               chessboardInstance.ground.state.movable.events.after = function (
                  fromSquare,
                  toSquare,
                  metadata,
               ) {
                  // Call the original handler first if it exists
                  if (
                     originalAfterMove &&
                     typeof originalAfterMove === "function"
                  ) {
                     originalAfterMove.call(
                        this,
                        fromSquare,
                        toSquare,
                        metadata,
                     );
                  }
                  updateGameInfo();
               };
            }

            /**
             * Check server health status
             */
            function checkServerHealth() {
               fetch("/health")
                  .then((response) => response.json())
                  .then((data) => {
                     const statusElement = document.getElementById("status");
                     if (statusElement) {
                        statusElement.textContent =
                           data.status === "ok"
                              ? "‚úì Server Online"
                              : "‚úó Server Offline";
                        statusElement.style.color =
                           data.status === "ok" ? "#28a745" : "#dc3545";
                     }
                     console.log("‚úÖ Server health check passed");
                  })
                  .catch((error) => {
                     const statusElement = document.getElementById("status");
                     if (statusElement) {
                        statusElement.textContent = "‚úó Server Error";
                        statusElement.style.color = "#dc3545";
                     }
                     console.error("‚ùå Failed to fetch health status:", error);
                  });
            }

            /**
             * Initialize everything on page load
             */
            function initializeApp() {
               setupChessboard();
               setupResetButton();
               setupMoveMonitoring();
               checkServerHealth();
            }

            // Ensure the DOM is fully loaded before initializing the app
            if (document.readyState === "loading") {
               document.addEventListener("DOMContentLoaded", initializeApp);
            } else {
               // DOMContentLoaded has already fired
               initializeApp();
            }
         </script>
      </div>
   </body>
</html>
